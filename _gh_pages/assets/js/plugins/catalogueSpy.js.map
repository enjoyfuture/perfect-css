{"version":3,"sources":["plugins/catalogueSpy.js"],"names":["isWheel","CatalogueSpy","perfect","doc","document","reg","scrollSpy","config","defaultConfig","menuHeight","$menuPanel","style","transform","maxHeight","addEventListener","handleScroll","console","info","step","prevent","event","scrollHeight","clientHeight","maxOffset","upDown","detail","wheelDelta","y","exec","parseFloat","preventDefault","stopPropagation","Math","abs","min","max","scrollMenu","lastSelector","menuRect","parentElement","getBoundingClientRect","currentTarget","querySelectorAll","join","Array","prototype","forEach","call","el","rect","top","bottom"],"mappings":"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","file":"catalogueSpy.js","sourcesContent":["import perfect from '../perfect';\nimport util from '../util';\nconst {isWheel} = util;\n\nconst CatalogueSpy = ((perfect) => {\n  const doc = document;\n  const reg = /translateY\\(([-\\w]+)\\)/;\n\n  class CatalogueSpy {\n    static defaultConfig = {\n      menuHeight: null, // 设置菜单高度，如果不设置，则取当前浏览器可视高度\n      step: 10, // 滚动鼠标，菜单滑动步长\n    };\n\n    constructor(scrollSpy, config = {}) {\n      this.scrollSpy = scrollSpy;\n      this.config = {...CatalogueSpy.defaultConfig, ...config};\n\n      let {menuHeight} = this.config;\n      if (!menuHeight) {\n        menuHeight = 400; // todo ，取浏览器可视化高度，待实现\n        this.config.menuHeight = menuHeight;\n      }\n\n      const {$menuPanel} = scrollSpy;\n      $menuPanel.style.transform = 'translateY(0)';\n      $menuPanel.style.maxHeight = `${menuHeight}px`;\n      this.$menuPanel = $menuPanel;\n    }\n\n    mount() {\n      // fixme 待改进，改成 scrollSpy 触发该事件，参考 web-guide 项目\n      // http://www.zhangxinxu.com/wordpress/2013/04/js-mousewheel-dommousescroll-event/\n      this.$menuPanel.addEventListener(isWheel ? 'mousewheel' : 'DOMMouseScroll', this.handleScroll(true), false);\n    }\n\n    handleScroll = (prevent) => {\n      return (event) => {\n        const {scrollHeight, clientHeight} = this.$menuPanel;\n        const {step} = this.config;\n        this.maxOffset = scrollHeight - clientHeight; // 最大滚动的高度\n\n        // 判断鼠标滑轮向上还是向下滑动\n        let upDown;\n        const {detail, wheelDelta} = event;\n        if (detail) {\n          if (detail < 0) { // up\n            upDown = 'up';\n          } else if (detail > 0) { // down\n            upDown = 'down';\n          }\n        } else if (wheelDelta) { //\n          if (wheelDelta > 0) { // up\n            upDown = 'up';\n          }\n          if (wheelDelta < 0) { // down\n            upDown = 'down';\n          }\n        }\n\n        const {transform} = this.$menuPanel.style;\n\n        let y = reg.exec(transform);\n        y = y ? parseFloat(y[1], 10) : 0;\n\n        if (prevent && this.maxOffset > 0) {\n          event.preventDefault();\n          event.stopPropagation();\n        }\n\n        if ((upDown === 'up' && y === 0) || (upDown === 'down' && Math.abs(y) === this.maxOffset)) {\n          return;\n        }\n\n        if (upDown === 'up' && y < 0) {\n          this.$menuPanel.style.transform = `translateY(${Math.min(y + step, 0)}px)`;\n        } else if (upDown === 'down' && Math.abs(y) < this.maxOffset) {\n          this.$menuPanel.style.transform = `translateY(${Math.max(y - step, -this.maxOffset)}px)`;\n        }\n      };\n    };\n\n    // 当定位到某一个菜单项时，而由于限制了高度，该菜单有可能不在可视范围内\n    scrollMenu = (lastSelector) => {\n      const {step} = this.config;\n      const {$menuPanel} = this;\n      const {scrollHeight, clientHeight} = $menuPanel;\n      const maxOffset = scrollHeight - clientHeight; // 最大滚动的高度\n      if (maxOffset === 0) {\n        return;\n      }\n      // 如果当前菜单项隐藏，则向上拉\n      // Fixme 注意这里还需计算 $menuPanel.parentElement padding 和 border 的值\n      // 待处理\n      const menuRect = $menuPanel.parentElement.getBoundingClientRect();\n      const currentTarget = doc.querySelectorAll(lastSelector.join(','));\n      Array.prototype.forEach.call(currentTarget, (el) => {\n        let rect = el.getBoundingClientRect();\n        while (rect.top < menuRect.top || rect.bottom > menuRect.bottom) { // 向上移动\n          const {transform} = $menuPanel.style;\n          let y = reg.exec(transform);\n          y = y ? parseFloat(y[1], 10) : 0;\n          if (rect.top < menuRect.top) {\n            $menuPanel.style.transform = `translateY(${Math.min(y + step, 0)}px)`;\n          } else {\n            $menuPanel.style.transform = `translateY(${Math.max(y - step, -maxOffset)}px)`;\n          }\n          rect = el.getBoundingClientRect();\n        }\n      });\n    };\n\n    unmount() {\n      console.info('待补充');\n    }\n\n  }\n\n  perfect.CatalogueSpy = CatalogueSpy;\n  return CatalogueSpy;\n})(perfect);\n\nexport default CatalogueSpy;\n"]}