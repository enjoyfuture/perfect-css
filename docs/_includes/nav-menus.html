{% assign pagePath = page.url | split: '/' %}
{% assign pagePathSize = pagePath | size %}
{% assign pageLastPath = pagePath | last %}

{% assign prefix = nil %}
{% assign dataMenu = nil %}
{% if page.layout == 'docs' %}
{% assign prefix = 'docs' %}
{% assign dataMenu = site.data.docs-menu%}
{% else if page.layout == 'components' %}
{% assign prefix = 'components' %}
{% assign dataMenu = site.data.components-menu %}
{% endif %}

<ul class="menu perfect-menu">

  {% for group in dataMenu %}
  {% assign firstPage = group.pages | first %}
  {% assign link = firstPage.file %}

  {% assign active = nil %}
  {% if page.group == group.file %}
  {% assign active = 'active' %}
  {% endif %}
  <li class="menu-item">
    <a {% if group.file %}href="/{{ prefix }}/{{ group.file }}/{{ link }}{% if link %}/{% endif %}" {% endif %}
       class="menu-title menu-header {{ active }}" style="padding-left: 1rem;">{{ group.title }}</a>
    <ul class="menu"{% if page.group != group.file %} style="display: none;"{% endif %}>
      {% for doc in group.pages %}
      {% assign active = nil %}

      {% if page.group == group.file and doc.file == pageLastPath %}
      {% assign active = ' active' %}
      {% endif %}

      {% assign padding = 2 %}

      <li class="menu-item">
        <a href="/{{ prefix }}/{{ group.file }}/{{ doc.file }}/"
             class="menu-title menu-sub-title{{ active }}" style="padding-left: 2rem;">{{ doc.title }}</a></li>
      {% endfor %}
    </ul>
  </li>
  {% endfor %}
</ul>

<script>
  $(function () {
    // 菜单超过一屏可以滚动查看
    var $menuPanel = $('.drawer-content')[0];
    var $menu = $('.drawer-content > .perfect-menu')[0];

    $menu.addEventListener('transitionend', function () {
      $menu.style.transition = 'unset';
    });
    $('.menu').on('click', '.menu-header', function (e) {
      e.preventDefault();
      // 隐藏其他打开的菜单
      $('.menu .menu').slideUp();
      var $el = $(e.currentTarget);
      var $nextEl = $el.next();
      if ($nextEl.is(':visible')) {
        $nextEl.slideUp();
      } else {
        $nextEl.slideDown(true, function () {
          var menuPanelTop = $menuPanel.getBoundingClientRect().top;
          var menuTop = $menu.getBoundingClientRect().top;
          var currentElTop = e.currentTarget.getBoundingClientRect().top;
          if (currentElTop < menuPanelTop) {
            $menu.style.transform = `translateY(${menuTop - currentElTop}px)`;
            $menu.style.transition = 'transform 200ms ease-in-out';
          }
        });
      }
    });

    const isWheel = (() => {
      const ua = navigator.userAgent;
      if (/gecko/i.test(ua) && !(/webkit/i.test(ua)) && (/firefox/i.test(ua))) { // Firefox
        return false;
      }
      return true;
    })();
    const reg = /translateY\(([-\w]+)\)/;

    $menuPanel.addEventListener(isWheel ? 'mousewheel' : 'DOMMouseScroll', function (event) {
      const {scrollHeight, clientHeight} = $menuPanel;
      const step = 20;
      const maxOffset = scrollHeight - clientHeight; // 最大滚动的高度

      // 判断鼠标滑轮向上还是向下滑动
      let upDown;
      const {detail, wheelDelta} = event;
      if (detail) {
        if (detail < 0) { // up
          upDown = 'up';
        } else if (detail > 0) { // down
          upDown = 'down';
        }
      } else if (wheelDelta) { //
        if (wheelDelta > 0) { // up
          upDown = 'up';
        }
        if (wheelDelta < 0) { // down
          upDown = 'down';
        }
      }

      const {transform} = $menu.style;

      let y = reg.exec(transform);
      y = y ? parseFloat(y[1], 10) : 0;

      if ((upDown === 'up' && y === 0) || (upDown === 'down' && Math.abs(y) === maxOffset)) {
        return;
      }

      if (maxOffset > 0) {
        event.preventDefault();
        event.stopPropagation();
      }

      if (upDown === 'up' && y < 0) {
        $menu.style.transform = `translateY(${Math.min(y + step, 0)}px)`;
      } else if (upDown === 'down' && Math.abs(y) < maxOffset) {
        $menu.style.transform = `translateY(${Math.max(y - step, -maxOffset)}px)`;
      }
    }, false);

  });
</script>
