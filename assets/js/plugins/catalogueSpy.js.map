{"version":3,"sources":["plugins/catalogueSpy.js"],"names":["isWheel","win","window","doc","document","resizeEvt","reg","_CatalogueSpy","scrollSpy","config","defaultConfig","menuHeight","documentElement","clientHeight","$menuPanel","style","transform","maxHeight","addEventListener","adjustMenuHeight","handleScroll","console","info","removeEventListener","step","prevent","event","scrollHeight","maxOffset","preventDefault","stopPropagation","upDown","detail","wheelDelta","y","exec","parseFloat","Math","abs","min","max","scrollMenu","lastSelector","menuRect","parentElement","getBoundingClientRect","currentTarget","querySelectorAll","join","Array","prototype","forEach","call","el","rect","top","bottom","CatalogueSpy","perfect"],"mappings":"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","file":"catalogueSpy.js","sourcesContent":["import perfect from '../perfect';\nimport util from '../util';\n\nconst {isWheel} = util;\n\nconst win = window;\nconst doc = document;\nconst resizeEvt = 'orientationchange' in win ? 'orientationchange' : 'resize';\n\nconst reg = /translateY\\(([-\\w]+)\\)/;\n\nclass _CatalogueSpy {\n  static defaultConfig = {\n    menuHeight: null, // 设置菜单高度，如果不设置，则取当前浏览器可视高度\n    step: 30, // 滚动鼠标，菜单滑动步长\n  };\n\n  constructor(scrollSpy, config = {}) {\n    this.scrollSpy = scrollSpy;\n    this.config = {..._CatalogueSpy.defaultConfig, ...config};\n\n    let {menuHeight} = this.config;\n    if (!menuHeight) {\n      menuHeight = document.documentElement.clientHeight - 64;\n      this.config.menuHeight = menuHeight;\n    }\n\n    const {$menuPanel} = scrollSpy;\n    $menuPanel.style.transform = 'translateY(0)';\n    $menuPanel.style.maxHeight = `${menuHeight}px`;\n    this.$menuPanel = $menuPanel;\n\n    win.addEventListener(resizeEvt, this.adjustMenuHeight, false);\n  }\n\n  // 调整菜单最大高度\n  adjustMenuHeight = () => {\n    const menuHeight = doc.documentElement.clientHeight - 64;\n    this.$menuPanel.style.maxHeight = `${menuHeight}px`;\n  };\n\n  mount() {\n    // fixme 待改进，改成 scrollSpy 触发该事件，参考 web-guide 项目\n    // http://www.zhangxinxu.com/wordpress/2013/04/js-mousewheel-dommousescroll-event/\n    this.$menuPanel.addEventListener(isWheel ? 'mousewheel' : 'DOMMouseScroll', this.handleScroll(true), false);\n  }\n\n  handleScroll = (prevent) => {\n    return (event) => {\n      const {scrollHeight, clientHeight} = this.$menuPanel;\n      const {step} = this.config;\n      this.maxOffset = scrollHeight - clientHeight; // 最大滚动的高度\n\n      if (prevent && this.maxOffset > 0) {\n        event.preventDefault();\n        event.stopPropagation();\n      }\n\n      // 判断鼠标滑轮向上还是向下滑动\n      let upDown;\n      const {detail, wheelDelta} = event;\n      if (detail) {\n        if (detail < 0) { // up\n          upDown = 'up';\n        } else if (detail > 0) { // down\n          upDown = 'down';\n        }\n      } else if (wheelDelta) { //\n        if (wheelDelta > 0) { // up\n          upDown = 'up';\n        }\n        if (wheelDelta < 0) { // down\n          upDown = 'down';\n        }\n      }\n\n      const {transform} = this.$menuPanel.style;\n\n      let y = reg.exec(transform);\n      y = y ? parseFloat(y[1], 10) : 0;\n\n      if ((upDown === 'up' && y === 0) || (upDown === 'down' && Math.abs(y) === this.maxOffset)) {\n        return;\n      }\n\n      if (upDown === 'up' && y < 0) {\n        this.$menuPanel.style.transform = `translateY(${Math.min(y + step, 0)}px)`;\n      } else if (upDown === 'down' && Math.abs(y) < this.maxOffset) {\n        this.$menuPanel.style.transform = `translateY(${Math.max(y - step, -this.maxOffset)}px)`;\n      }\n    };\n  };\n\n  // 当定位到某一个菜单项时，而由于限制了高度，该菜单有可能不在可视范围内\n  scrollMenu = (lastSelector) => {\n    const {step} = this.config;\n    const {$menuPanel} = this;\n    const {scrollHeight, clientHeight} = $menuPanel;\n    let maxOffset = scrollHeight - clientHeight; // 最大滚动的高度\n    if (maxOffset === 0) {\n      return;\n    }\n    maxOffset += 1; // 由于计算偏差，需要微调1个像素\n    // 如果当前菜单项隐藏，则向上拉\n    // Fixme 注意这里还需计算 $menuPanel.parentElement padding 和 border 的值，待处理\n    const menuRect = $menuPanel.parentElement.getBoundingClientRect();\n    const currentTarget = doc.querySelectorAll(lastSelector.join(','));\n    if (currentTarget) {\n      Array.prototype.forEach.call(currentTarget, (el) => {\n        let rect = el.getBoundingClientRect();\n        while (rect.top > 0 && rect.bottom > 0 && (rect.top < menuRect.top || rect.bottom > menuRect.bottom)) { // 向上移动\n          const {transform} = $menuPanel.style;\n          let y = reg.exec(transform);\n          y = y ? parseFloat(y[1], 10) : 0;\n          if (rect.top < menuRect.top) {\n            $menuPanel.style.transform = `translateY(${Math.min(y + step, 0)}px)`;\n          } else {\n            $menuPanel.style.transform = `translateY(${Math.max(y - step, -maxOffset)}px)`;\n          }\n          rect = el.getBoundingClientRect();\n        }\n      });\n    }\n  };\n\n  unmount() {\n    console.info('待补充');\n    win.removeEventListener(resizeEvt, this.adjustMenuHeight, false);\n  }\n\n}\n\nconst CatalogueSpy = ((perfect) => {\n  perfect.CatalogueSpy = _CatalogueSpy;\n  return _CatalogueSpy;\n})(perfect);\n\nexport default CatalogueSpy;\n"]}